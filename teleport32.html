<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR Button Interaction</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script type="module">
    import * as THREE from 'three';
    import { XRButton } from 'three/addons/webxr/XRButton.js';

    // Definir botones y ejes del mapeo XR
    const BUTTONS = {
      TRIGGER: 0,        // Gatillo principal (TRIGGER): selecciona objetos o dispara.
      SQUEEZE: 1,        // Botón de agarre (SQUEEZE): puede usarse para agarrar objetos.
      TOUCHPAD: 2,       // Panel táctil (TOUCHPAD): usado para navegación o menús.
      THUMBSTICK: 3,     // Palanca analógica (THUMBSTICK): para mover el objeto.
      BUTTON_1: 4,       // Botón auxiliar 1 (BUTTON_1): acción secundaria personalizada.
      BUTTON_2: 5,       // Botón auxiliar 2 (BUTTON_2): otra acción personalizada.
    };

    const AXES = {
      TOUCHPAD_X: 0,     // Panel táctil: eje horizontal.
      TOUCHPAD_Y: 1,     // Panel táctil: eje vertical.
      THUMBSTICK_X: 2,   // Palanca analógica: eje horizontal.
      THUMBSTICK_Y: 3,   // Palanca analógica: eje vertical.
    };

    // Configuración de la escena
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 3); // Cámara inicial a 1.6m de altura.

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(XRButton.createButton(renderer));

    // Luz de ambiente
    const light = new THREE.HemisphereLight(0xffffff, 0x444444);
    light.position.set(0, 1, 0);
    scene.add(light);

    // Crear un cubo para interactuar
    const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
    const material = new THREE.MeshStandardMaterial({ color: 0x0077ff });
    const cube = new THREE.Mesh(geometry, material);
    scene.add(cube);

    // Variables para los controladores
    let controllers = [];

    // Crear controladores XR
    function buildController(index) {
      const controller = renderer.xr.getController(index);

      // Eventos de botones:
      controller.addEventListener('selectstart', () => console.log('TRIGGER (gatillo) presionado.'));
      controller.addEventListener('selectend', () => console.log('TRIGGER (gatillo) liberado.'));
      controller.addEventListener('squeezestart', () => console.log('SQUEEZE (agarre) presionado.'));
      controller.addEventListener('squeezeend', () => console.log('SQUEEZE (agarre) liberado.'));

      scene.add(controller);
      controllers[index] = controller;
    }

    // Detectar y agregar controladores XR al iniciar sesión
    renderer.xr.addEventListener('sessionstart', () => {
      for (let i = 0; i < 2; i++) {
        buildController(i);
      }
    });

    // Actualizar el cubo con los joysticks
    function updateController(controller) {
      const gamepad = controller.inputSource.gamepad;
      if (gamepad) {
        // Obtener valores de los ejes del THUMBSTICK
        const xAxis = gamepad.axes[AXES.THUMBSTICK_X];
        const yAxis = gamepad.axes[AXES.THUMBSTICK_Y];
        
        // Mover el cubo según los ejes
        cube.position.x += xAxis * 0.05;
        cube.position.z += yAxis * 0.05;

        // Revisar cada botón
        gamepad.buttons.forEach((button, index) => {
          if (button.pressed) {
            switch (index) {
              case BUTTONS.TRIGGER:
                console.log('TRIGGER (gatillo): Activando selección.');
                break;
              case BUTTONS.SQUEEZE:
                console.log('SQUEEZE (agarre): Agarrar objeto.');
                break;
              case BUTTONS.TOUCHPAD:
                console.log('TOUCHPAD: Usado para navegación.');
                break;
              case BUTTONS.THUMBSTICK:
                console.log('THUMBSTICK: Usado para movimiento.');
                break;
              case BUTTONS.BUTTON_1:
                console.log('BUTTON_1: Acción secundaria.');
                break;
              case BUTTONS.BUTTON_2:
                console.log('BUTTON_2: Acción terciaria.');
                break;
            }
          }
        });
      }
    }

    // Animación
    function animate() {
      renderer.setAnimationLoop(() => {
        controllers.forEach(updateController); // Actualizar controladores en cada frame.
        renderer.render(scene, camera);
      });
    }

    // Iniciar animación
    animate();
  </script>
</body>
</html>
